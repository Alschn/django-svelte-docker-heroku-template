<div align="center" style="padding-bottom: 20px">
    <h1>Django + Svelte + Postgres + Docker + Fly.io template</h1>
    <img src="https://img.shields.io/badge/Python-14354C?style=for-the-badge&logo=python&logoColor=white" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/Django-092E20?style=for-the-badge&logo=django&logoColor=white" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/Svelte-4A4A55?style=for-the-badge&logo=svelte&logoColor=FF3E00" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/Sass-CC6699?style=for-the-badge&logo=sass&logoColor=white" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/Docker-008FCC?style=for-the-badge&logo=docker&logoColor=white" alt=""/>&nbsp;
    <img src="https://img.shields.io/badge/Fly.io-7B36ED?style=for-the-badge&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKcAAACXCAMAAABHsrtzAAACcFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////WkqE9AAAAz3RSTlMAAQIDBAUGBwgJCgsMDQ4PEBESExQVFhcYGRobHB0eHyAhIiMkJSYnKCkqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlbXF1eYWJjZGVnaGlqbG1xc3R3eHp9f4CBgoOEiIuMjZCRkpSVlpmam52foKKjpaanqKmqq6ytrq+ys7S1t7i5u72+v8DCxMfJyszNz9DR0tPU1dbY2drb3d7g4ePk5ebn6Onq6+zt7/Hy8/T19vj5+vv8/f6aQaHzAAAAAWJLR0TPg97C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&logoColor=white" alt=""/>&nbsp;
</div>

TODO

### Why Svelte rendered in Django templates?

TODO

### How does it work?

TODO

### Tools, libraries, frameworks:

This setup has been tested with Python 3.11 and Node 16.

### Backend

- Django + Django Rest Framework `django` `djangorestframework`
- `django-extensions` - useful utilities (e.g better shell)
- `django-cors-headers` - handling cross origin requests
- `coverage` - for code coverage reports and running unit tests
- `mypy` + `djangorestframework-stubs` - for better typing experience
- `psycopg2` - needed to use Postgres (in Docker container)
- `gunicorn` - production wsgi http server
- `whitenoise` - building static files
- `pipenv` - replacement for venv

Suggested packages:

- `sentry-sdk` - for error reporting in production
- `django-debug-toolbar` - for debugging purposes
- `django-filter` - enables filtering querysets with url parameters and more
- `drf-spectacular` - open api documentation (swagger and redoc)
- `channels` - websockets backend
- `djangorestframework-simplejwt`, `dj-rest-auth`, `django-allauth`, `djoser` - making auth easier
- `django-import-export` - import/export data from admin page
- `django-ninja` - API framework similar to Fast API but tied with Django
- `pytest` - alternative to built-in unittest
- `playwright` / `selenium` - for e2e testing

Useful materials:

- https://docs.djangoproject.com/en/4.1/
- https://github.com/wsvincent/awesome-django

### Frontend

- Svelte `svelte`
- Typescript `typescript`
- `sass` - enables scss/sass support
- `axios` - http requests client
- `vite` - bundler
- `vitest`, `@testing-library/svelte` + additional packages - unit testing components
- `pnpm` - package manager

Suggested packages:

- UI libraries such as `TailwindCSS`, `Svelte Material UI`, `Smelte`, `Carbon Components Svelte`,
  `Svelte Materialify`, `Sveltestrap` etc.

Useful materials:

- https://svelte.dev/docs
- https://github.com/TheComputerM/awesome-svelte

# Development setup

## Without Docker

### Backend

Create a virtual environment and install dependencies from Pipfile with `pipenv`

```shell
cd backend

mkdir .venv

pipenv shell

pipenv run pip install --upgrade pip

pipenv install
```

If you are not using Docker, then you need to create a `.env` file in the `backend` directory and add the following
variables:

```dotenv
SECRET_KEY=your_secret_key
```

If you have multiple Python interpreters installed and you want to use version specified in the Pipfile, then you can
run commands prefixed with `pipenv run`, otherwise first one from the system path will be used.

```shell
pipenv run COMMAND
```

Run django application from cmd (or add new Django configuration if using Pycharm)

```shell script
python manage.py runserver
```

Preparing (if there are any changes to db schema) and running migrations

```shell script
python manage.py makemigrations

python manage.py migrate
```

Create superuser

```shell script
python manage.py createsuperuser
```

#### Backend tests and coverage

```shell script
cd backend
```

Run tests using Coverage instead of `python manage.py test`

```shell script
coverage run manage.py test
```

Get report from coverage:

```shell script
coverage report -m
```

### Frontend

Install node dependencies. You may use **npm** instead of **pnpm** if you wish.

```shell script
cd frontend

pnpm install
```

Run development server in second terminal (build script in watch mode)

```shell script
pnpm dev
```

#### Frontend tests and coverage

```shell
cd frontend
```

Run tests and gather coverage report

```shell
pnpm run test

pnpm run coverage
```

Run tests with Vitest in watch mode

```shell
pnpm test:watch
```

## With Docker

**IMPORTANT**: You need to change CRLF to LF in entrypoint-dev.sh, entrypoint-prod.sh and entrypoint-build.sh,
otherwise build will fail because Linux uses different line endings than Windows.
You can do this e.g. using Pycharm, choosing LF in Line Separator at the bottom bar.
Other files are not affected by this issue.

Create `env` directory in project's **root directory** and add corresponding .env files with environment variables:

`env/backend.env`

```dotenv
SECRET_KEY=your_secret_key
DJANGO_SETTINGS_MODULE=core.settings.dev

DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=postgres_db
DB_PORT=5432
```

`env/frontend.env`

```dotenv
CHOKIDAR_USEPOLLING=true
NODE_ENV=development
DOCKER=true
```

`env/postgres.env`

```dotenv
POSTGRES_DB=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
```

Make sure Docker Engine is running.

### Development configuration

While in **root directory**, build docker images and run them with docker-compose.
This might take up to few minutes. Rebuilding image is crucial after installing new packages via pip or npm.

```shell
docker-compose up --build
```

Application should be up and running at `http://127.0.0.1:8000`.
Frontend build server runs in the background, does not output anything to the browser.

If images had been installed and no additional packages have been installed, just run to start containers:

```shell
docker-compose up
```

Bringing down containers with **optional** `-v` flag removes all attached volumes and invalidates caches.

```shell
docker-compose down
```

To run commands in active container:

```shell
docker exec -it CONTAINER_NAME COMMAND
```

e.g.

```shell
docker exec -it backend python manage.py bash
```

Rebuilding individual containers instead of all of them

```shell
docker-compose build CONTAINER_NAME
```

```shell
docker-compose build CONTAINER_NAME --no-cache
```

# Deployment

Useful links:

- [Fly.io Docs](https://fly.io/docs/)
- [Fly.io CLI](https://fly.io/docs/flyctl/)
- [Fly.io Dashboard](https://fly.io/dashboard/)

### Launch

To configure and launch the app, run the `fly launch` command and follow the wizard.
You need to provision a Postgres database before launching the app.

### Environment variables

Set environment variables in Fly.io dashboard or via `flyctl` cli.

```dotenv
SECRET_KEY=...
PRODUCTION_HOST=<your_app_name>.fly.dev
```

```shell
fly secrets set VARIABLE=...
```

### GitHub secrets

Obtain Fly.io API key and add it as a secret to your repository to enable continuous deployments.

```shell
fly auth token
```

### Manual deployment

```shell
fly deploy
```

### Connect to a running instance

```shell
fly ssh console
```

---

# TO DO:

- Some prettier examples (Django + Svelte integration), description, how it works
- Setup with Nginx in production (?)
